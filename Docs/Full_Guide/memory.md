# Memory in mbed OS
mbed OS provides memory allocation services that are based on a standard memory organization, described below. The memory allocation services provide for most use-cases in memory allocation, including heap allocation, pool allocation, and extendable pools.

## Memory Organization in mbed OS
In a conventional embedded system, there are four areas of memory: Code, Global Data, the heap, and the stack. Frequently, the heap and the stack are organized so that they occupy the same block of memory. In mbed OS, we add two additional areas of memory: uVisor memory and the never free heap. Memory is organized as below. Note that code generally lives in ROM, so it is not included in this diagram.

```
Cortex-M3/M4            Cortex-M0/M+        
Largest RAM address     Largest RAM address 
+-----------------+     +-----------------+ 
| Never Free Heap |     | Never Free Heap | 
|                 |     |                 | 
|      Heap       |     |      Heap       | 
+-----------------+     +-----------------+ 
|   Global Data   |     |   Global Data   | 
+-----------------+     +-----------------+ 
|      Stack      |     |      Stack      | 
+-----------------+     +-----------------+ 
|  uVisor Memory  |     Smallest RAM address
+-----------------+   
Smallest RAM address  
```

### uVisor Memory
On Cortex-M3/M4, the uVisor reserves a small portion of memory at the beginning of RAM for itself and for secured features (boxes). The uVisor secures this area using the MPU. For more information on the uVisor, see [our main site](https://www.mbed.com/en/technologies/security/uvisor/)

### Stack
The stack is placed at the bottom of the memory, and it grows downwards. This location is selected explicitly because it allows stack overflows to be easily caught. In a Cortex-M3/M4 system, where the uVisor is in use, the first access below the bottom of the stack will trigger a [MemManage](http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0552a/Cihgggbh.html) exception, handled by the uVisor. In a Cortex-M0/M0+ system, it will trigger a [HardFault](http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0497a/Babcefea.html). This allows applications to recover from stack overflows, generally through a reset.

This organization does mean that a stack must be sized to match the application. Currently, this is a value set in the target, but a future version will expose stack configuration through yotta config.

### Global Data
Global Data is the typical ``.bss`` and ``.data`` sections generated by the compiler. This section's size depends on the application and requires no configuration.

### Heaps
There are two kinds of heap in mbed OS. The heap grows upwards from the bottom of the heap section, while the never free heap grows downwards from the top.

#### The Standard Heap
The heap is a typical dlmalloc heap, which grows upwards from the bottom of the heap section using the ```sbrk``` function provided by the [core-util](https://github.com/ARMmbed/core-util) module.

#### The Never Free Heap
The never free heap grows downwards from the end of memory. The never free heap is intended for use with data that need not be freed, such as memory pools. Memory is allocated from the never free heap using the reverse sbrk function (```krbs```) provided by the [core-util](https://github.com/ARMmbed/core-util) module.


